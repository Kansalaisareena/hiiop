machine:
  services:
    - redis

  timezone:
    Europe/Helsinki # Set the timezone

  environment:
    CIRCLE_BUILD_DIR: $HOME/$CIRCLE_PROJECT_REPONAME
    PATH: $PATH:$CIRCLE_BUILD_DIR/bin
    DATABASE_URL: postgres://ubuntu:@127.0.0.1:5432/circle_test

  post:
    - mkdir -p $CIRCLE_BUILD_DIR/bin

dependencies:
  cache_directories:
    - bin
  pre:
    - bash ./scripts/ci-install-sassc.sh

database:
  override:
    - lein migratus migrate

deployment:
  development:
    branch: master
    commands:
      - lein uberjar
      - HIIOP_ASSET_BUCKET="hiiop-dev" lein essthree
      - heroku git:remote --app hiiop-dev
      - heroku maintenance:on --app hiiop-dev
      - DATABASE_URL="$(heroku config:get "DATABASE_URL" --app hiiop-dev)?sslmode=require" lein migratus migrate
      - HEROKU_APP="hiiop-dev" lein heroku deploy-uberjar
      - heroku maintenance:off --app hiiop-dev

